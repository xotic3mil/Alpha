@model ProjectViewModel


@{
    ViewData["Title"] = "Project Page";
}
<div class="pt-3">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3">
        <h1 class="h2">Projects</h1>
        <div class="btn-toolbar">
            <button href="#"
                    data-bs-toggle="modal"
                    data-bs-target="#addProjectModal"
                    type="button"
                    class="btn btnAdd me-2">
                + Project
            </button>
        </div>
    </div>
        <ul class="nav mb-4">
            <li class="nav-item">
                <a class="nav-link @(ViewBag.StatusFilter == null || ViewBag.StatusFilter == "All" ? "active" : "")"
                   asp-controller="Project" asp-action="Index">
                    All Projects (@(ViewBag.TotalCount ?? 0))
                </a>
            </li>
            @if (ViewBag.StatusCounts != null)
            {
                @foreach (var statusGroup in ViewBag.StatusCounts)
                {
                    <li class="nav-item">
                        <a class="nav-link @(ViewBag.StatusFilter == statusGroup.Key ? "active" : "")"
                           asp-controller="Project" asp-action="Index" asp-route-statusFilter="@statusGroup.Key">
                            @statusGroup.Key (@statusGroup.Value)
                        </a>
                    </li>
                }
            }
        </ul>
    <div class="row g-3">
            @if (ViewBag.SuccessMessage != null)
            {
                <div class="alert alert-success">
                    @ViewBag.SuccessMessage
                </div>
            }

            @if (!ViewData.ModelState.IsValid)
            {
                <div class="alert alert-danger">
                    <ul>
                        @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
                        {
                            <li>@error.ErrorMessage</li>
                        }
                    </ul>
                </div>
            }
             @foreach (var project in Model.Projects)
            {
                @await Html.PartialAsync("_ProjectCardPartial", project)
            } 
    </div>
</div>

    @await Html.PartialAsync("_CreateProjectPartial", Model)
    @await Html.PartialAsync("_EditProjectPartial", Model)
    @await Html.PartialAsync("_ProjectDetailsPartial", Model)


@section Scripts {
    <script>
        function createRipple(event) {
            const button = event.currentTarget;
            const ripple = button.querySelector(".ripple");
            if (ripple) {
                ripple.remove();
            }

            const circle = document.createElement("span");
            const diameter = Math.max(button.clientWidth, button.clientHeight);
            const radius = diameter / 2;

            const rect = button.getBoundingClientRect();
            circle.style.width = circle.style.height = `${diameter}px`;
            circle.style.left = `${event.clientX - rect.left - radius}px`;
            circle.style.top = `${event.clientY - rect.top - radius}px`;
            circle.classList.add("ripple");

            button.appendChild(circle);
        }

        function openProjectDetails(id) {
            $.ajax({
                url: `/Project/GetProjectByIdWithDetails?id=${id}`,
                type: 'GET',
                dataType: 'json',
                success: function (project) {
                    console.log("Project data:", project);

                    $('#projectDetailImage').attr('src', project.imageUrl || '/images/project-template-1.svg');
                    $('#projectDetailName').text(project.name || 'Unnamed Project');
                    $('#projectDetailDescription').text(project.description || 'No description available');
                    $('#projectDetailDeleteId').val(project.id);

                    $('#projectDetailServiceName').text(project.service?.serviceName || 'No Service');
                    $('#projectDetailServiceDescription').text(project.service?.serviceDescription || 'No description available');
                    $('#projectDetailBudget').text(project.service?.budget ? `$${project.service.budget.toLocaleString()}` : 'N/A');


                    $('#projectDetailStatus').text(project.status?.statusName || 'No Status');
                    const statusColor = project.status?.colorCode || '#4caf50';
                    $('#projectDetailStatusIndicator').css('background-color', statusColor);
                    $('#projectDetailHeader').css('background-color', statusColor + '15');


                    $('#projectDetailStartDate').text(formatDateString(project.startDate) || 'Not set');
                    $('#projectDetailEndDate').text(formatDateString(project.endDate) || 'Not set');

                    if (project.endDate) {
                        const endDate = new Date(project.endDate);
                        const now = new Date();
                        const daysLeft = Math.ceil((endDate - now) / (1000 * 60 * 60 * 24));
                        $('#projectDetailTimeRemaining').text(daysLeft > 0 ? `${daysLeft} days left` : 'Overdue');
                    } else {
                        $('#projectDetailTimeRemaining').text('-');
                    }
                    

                    if (project.customer) {
                        $('#projectDetailCustomerName').text(project.customer.companyName || '-');
                        $('#projectDetailCustomerContact').text(project.customer.contactName || '-');
                        $('#projectDetailCustomerEmail').text(project.customer.email || '-');
                        $('#projectDetailCustomerPhone').text(project.customer.phoneNumber || '-');
                        
                        let address = [];
                        if (project.customer.address) address.push(project.customer.address);
                        if (project.customer.city) address.push(project.customer.city);
                        if (project.customer.country) address.push(project.customer.country);
                        
                        $('#projectDetailCustomerAddress').text(address.length > 0 ? address.join(', ') : '-');
                        $('#viewCustomerLink').attr('href', `/Customer/Details/${project.customer.id}`);
                    }
                    $('#commentForm').html(`
                        @Html.AntiForgeryToken()
                        <input type="hidden" id="commentProjectId" name="ProjectId" value="${project.id}" />
                        <div class="input-group">
                            <input type="text"
                                   id="commentContent"
                                   name="Content"
                                   class="form-control formBorder"
                                   placeholder="Add a status update comment..."
                                   required />
                            <button type="submit" class="btn btn-primary">Post</button>
                        </div>
                    `);

                    loadProjectMembers(project.id);
                    loadComments(project.id);
                    $('#projectDetailsModal').modal('show');

                    

                },
                error: function (error) {
                    console.error('Error fetching project details:', error);
                    alert('Failed to load project details. Please try again.');
                }
            });
        }

        function formatDateString(dateString) {
            if (!dateString) return null;

            const date = new Date(dateString);
            if (isNaN(date)) return null;

            return date.toLocaleDateString();
        }

        function loadComments(projectId) {
            console.log("Loading comments for project:", projectId);

            $('#commentsContainer').html(`
                <div class="text-center py-3">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="text-muted mt-2">Loading comments...</p>
                </div>
            `);

            $.ajax({
                url: `/Comment/GetProjectComments?projectId=${projectId}`,
                type: 'GET',
                success: function(comments) {
                    console.log("Comments loaded:", comments);
                    $('#commentsContainer').empty();
                    
                    if (!comments || comments.length === 0) {
                        $('#commentsContainer').html('<p class="text-muted text-center">No status updates yet. Add the first comment.</p>');
                        return;
                    }
                    
                    comments.forEach(comment => {
                        appendComment(comment);
                    });
                },
                error: function(error) {
                    console.error("Error loading comments:", error);
                    $('#commentsContainer').html('<p class="text-danger text-center">Failed to load status comments</p>');
                }
            });
        }

        function appendComment(comment) {
            const commentDate = new Date(comment.createdAt);
            const formattedDate = commentDate.toLocaleString();
            
            const commentHtml = `
                <div class="comment ${comment.isCurrentUser ? 'current-user' : ''}" data-comment-id="${comment.id}">
                    <div class="comment-header">
                        <div class="comment-user">
                            <img src="${comment.userAvatar || '/images/avatar-template-1.svg'}" class="comment-avatar" alt="${comment.userName}" />
                            <div>
                                <h6 class="comment-username">${comment.userName}</h6>
                                <small class="comment-time">${formattedDate}</small>
                            </div>
                        </div>
                        ${comment.isCurrentUser ? `
                        <div class="comment-actions">
                            <button type="button" onclick="deleteComment('${comment.id}', '${comment.projectId}')" class="text-danger">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                        ` : ''}
                    </div>
                    <div class="comment-content">${comment.content}</div>
                </div>
            `;
            
            $('#commentsContainer').prepend(commentHtml);
        }

        function deleteComment(commentId, projectId) {
            if (!confirm("Delete this status comment?")) {
                return;
            }

            const token = $('input[name="__RequestVerificationToken"]').first().val();

            $.ajax({
                url: '/Comment/Delete',
                type: 'POST',
                data: {
                    id: commentId,
                    projectId: projectId,
                    __RequestVerificationToken: token
                },
                success: function(response) {
                    $(`.comment[data-comment-id="${commentId}"]`).slideUp(200, function() {
                        $(this).remove();
                        
                        if ($('#commentsContainer').children().length === 0) {
                            $('#commentsContainer').html('<p class="text-muted text-center">No status updates yet. Add the first comment.</p>');
                        }
                    });
                },
                error: function(error) {
                    console.error("Error deleting comment:", error);
                    
                    if (error.status === 403) {
                        alert("You don't have permission to delete this comment.");
                    } else if (error.status === 401) {
                        alert("Your session has expired. Please log in again.");
                        window.location.href = "/Auth/Login";
                    } else {
                        alert("Failed to delete comment. Please try again.");
                    }
                }
            });
        }

        $(document).ready(function() {
            const buttons = document.querySelectorAll(
                ".btnAuth, .btnAdd, .btnGoogle, .btn-editor, .btn"
            );
            
            buttons.forEach((button) => {
                button.classList.add("ripple-button");
                button.addEventListener("mousedown", createRipple);
            });

            $(document).on('submit', '#commentForm', function(e) {
                e.preventDefault();
                
                const projectId = $('#commentProjectId').val();
                const content = $('#commentContent').val().trim();
                
                console.log("Submitting comment for project:", projectId);
                console.log("Comment content:", content);
                
                if (!content) {
                    console.log("Empty comment, not submitting");
                    return;
                }
                
                if (!projectId) {
                    console.log("Missing project ID, cannot submit");
                    alert("Error: Cannot add comment without project ID. Please try again.");
                    return;
                }
                
                $.ajax({
                    url: '/Comment/Create',
                    type: 'POST',
                    data: $(this).serialize(),
                    success: function(newComment) {
                        console.log("Comment created successfully:", newComment);
                        $('#commentContent').val('');
                        
                        if ($('#commentsContainer').find('.text-muted.text-center').length) {
                            $('#commentsContainer').empty();
                        }
                        
                        appendComment(newComment);
                    },
                    error: function(error) {
                        console.error("Error posting comment:", error);
                        console.error("Error details:", error.responseJSON);
                        alert("Failed to post status comment. Please try again.");
                    }
                });
            });
        });

                  function loadProjectMembers(projectId) {
            $('#projectDetailTeamMembers').html(`
                <div class="text-center py-3">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="visually-hidden">Loading team members...</span>
                    </div>
                    <p class="text-muted mt-2">Loading team members...</p>
                </div>
            `);

            $.ajax({
                url: `/ProjectMembership/GetProjectMembers?projectId=${projectId}`,
                type: 'GET',
                success: function(response) {
                    $('#projectDetailTeamMembers').empty();

                    if (!response.success) {
                        $('#projectDetailTeamMembers').html(`<p class="text-danger">${response.message || 'Error loading members'}</p>`);
                        return;
                    }

                    if (!response.members || response.members.length === 0) {
                        $('#projectDetailTeamMembers').html('<p class="text-muted">No team members assigned to this project.</p>');
                        return;
                    }

                    response.members.forEach(member => {
                        $('#projectDetailTeamMembers').append(`
                            <div class="team-member-item d-flex align-items-center mb-2 position-relative" data-member-id="${member.id}">
                                <img src="${member.avatarUrl}" alt="${member.firstName} ${member.lastName}"
                                     class="rounded-circle" style="width: 40px; height: 40px; object-fit: cover;">
                                <div class="ms-2">
                                    <div class="fw-medium">${member.firstName} ${member.lastName}</div>
                                    <div class="text-muted small">${member.email}</div>
                                </div>
                                <button type="button" class="btn btn-sm text-danger position-absolute end-0 top-0"
                                        onclick="removeMemberFromProject('${member.id}')">
                                    <i class="bi bi-x-circle"></i>
                                </button>
                            </div>
                        `);
                    });
                },
                error: function(error) {
                    console.error("Error loading team members:", error);
                    $('#projectDetailTeamMembers').html('<p class="text-danger">Failed to load team members</p>');
                }
            });


            loadPendingRequests(projectId);
        }

               function loadPendingRequests(projectId) {
            $.ajax({
                url: `/ProjectMembership/GetPendingRequests?projectId=${projectId}`,
                type: 'GET',
                success: function(response) {
                    if (!response.success) {
                        console.error(response.message);
                        return;
                    }

                    if (!response.requests || response.requests.length === 0) {
                        $('#pendingRequestsSection').hide();
                        return;
                    }

                    $('#pendingRequests').empty();
                    $('#pendingRequestsSection').show();

                    response.requests.forEach(request => {
                        const requestDate = new Date(request.requestDate);
                        $('#pendingRequests').append(`
                            <div class="request-item card bg-light mb-2" data-request-id="${request.id}">
                                <div class="card-body p-3">
                                    <div class="d-flex align-items-center mb-2">
                                        <img src="${request.userAvatarUrl}"
                                             class="rounded-circle me-2"
                                             style="width: 32px; height: 32px; object-fit: cover;">
                                        <div>
                                            <h6 class="mb-0">${request.userName}</h6>
                                            <small class="text-muted">${request.userEmail}</small>
                                        </div>
                                    </div>
                                    <p class="card-text small mb-2">
                                        ${request.message || 'No additional message'}
                                    </p>
                                    <div class="d-flex align-items-center justify-content-between">
                                        <small class="text-muted">Requested: ${requestDate.toLocaleDateString()}</small>
                                        <div>
                                            <button type="button" class="btn btn-sm btn-outline-danger"
                                                    onclick="rejectRequest('${request.id}')">Reject</button>
                                            <button type="button" class="btn btn-sm btn-success ms-1"
                                                    onclick="approveRequest('${request.id}')">Approve</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `);
                    });
                },
                error: function(error) {
                    console.error("Error loading pending requests:", error);
                }
            });
        }

                function openAddTeamMemberModal() {
            const projectId = $('#projectDetailDeleteId').val();
            $('#addTeamMemberProjectId').val(projectId);

            // Load available users
            $('#userSelect').html('<option value="" selected disabled>Loading users...</option>');
            $.ajax({
                url: `/ProjectMembership/GetAvailableUsers?projectId=${projectId}`,
                type: 'GET',
                success: function(response) {
                    $('#userSelect').empty();

                    if (!response.success) {
                        $('#userSelect').html(`<option value="" selected disabled>${response.message || 'Error loading users'}</option>`);
                        return;
                    }

                    if (!response.users || response.users.length === 0) {
                        $('#userSelect').html('<option value="" selected disabled>No available users</option>');
                        return;
                    }

                    $('#userSelect').append('<option value="" selected disabled>Select a user</option>');
                    response.users.forEach(user => {
                        $('#userSelect').append(`<option value="${user.id}">${user.name} (${user.email})</option>`);
                    });
                },
                error: function(error) {
                    console.error("Error loading available users:", error);
                    $('#userSelect').html('<option value="" selected disabled>Error loading users</option>');
                }
            });

            $('#addTeamMemberModal').modal('show');
        }

            function addMemberToProject() {
            const projectId = $('#addTeamMemberProjectId').val();
            const userId = $('#userSelect').val();

            if (!userId) {
                alert('Please select a user to add to the project');
                return;
            }

            $.ajax({
                url: '/ProjectMembership/AddUserToProject',
                type: 'POST',
                data: {
                    projectId: projectId,
                    userId: userId,
                    __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                },
                success: function(response) {
                    if (response.success) {
                        $('#addTeamMemberModal').modal('hide');
                        loadProjectMembers(projectId);
                    } else {
                        alert(response.message || 'Failed to add user to project');
                    }
                },
                error: function(error) {
                    console.error("Error adding user to project:", error);
                    alert('An error occurred while adding the user to the project');
                }
            });
        }

                function removeMemberFromProject(userId) {
            if (!confirm('Are you sure you want to remove this team member from the project?')) {
                return;
            }

            const projectId = $('#projectDetailDeleteId').val();

            $.ajax({
                url: '/ProjectMembership/RemoveUserFromProject',
                type: 'POST',
                data: {
                    projectId: projectId,
                    userId: userId,
                    __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                },
                success: function(response) {
                    if (response.success) {
                        $(`.team-member-item[data-member-id="${userId}"]`).fadeOut(300, function() {
                            $(this).remove();

                            if ($('#projectDetailTeamMembers').children().length === 0) {
                                $('#projectDetailTeamMembers').html('<p class="text-muted">No team members assigned to this project.</p>');
                            }
                        });
                    } else {
                        alert(response.message || 'Failed to remove user from project');
                    }
                },
                error: function(error) {
                    console.error("Error removing user from project:", error);
                    alert('An error occurred while removing the user from the project');
                }
            });
        }

                function approveRequest(requestId) {
            if (!confirm('Are you sure you want to approve this request?')) {
                return;
            }

            $.ajax({
                url: '/ProjectMembership/ApproveRequest',
                type: 'POST',
                data: {
                    requestId: requestId,
                    __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                },
                success: function(response) {
                    if (response.success) {
                        const projectId = $('#projectDetailDeleteId').val();
                        $(`.request-item[data-request-id="${requestId}"]`).fadeOut(300, function() {
                            $(this).remove();

                            if ($('#pendingRequests').children().length === 0) {
                                $('#pendingRequestsSection').hide();
                            }
                            loadProjectMembers(projectId);
                        });
                    } else {
                        alert(response.message || 'Failed to approve request');
                    }
                },
                error: function(error) {
                    console.error("Error approving request:", error);
                    alert('An error occurred while approving the request');
                }
            });
        }

        function rejectRequest(requestId) {
            if (!confirm('Are you sure you want to reject this request?')) {
                return;
            }

            $.ajax({
                url: '/ProjectMembership/RejectRequest',
                type: 'POST',
                data: {
                    requestId: requestId,
                    __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                },
                success: function(response) {
                    if (response.success) {
                        $(`.request-item[data-request-id="${requestId}"]`).fadeOut(300, function() {
                            $(this).remove();

                            if ($('#pendingRequests').children().length === 0) {
                                $('#pendingRequestsSection').hide();
                            }
                        });
                    } else {
                        alert(response.message || 'Failed to reject request');
                    }
                },
                error: function(error) {
                    console.error("Error rejecting request:", error);
                    alert('An error occurred while rejecting the request');
                }
            });
        }

    </script>
}